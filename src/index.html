<!doctype html>

<html lang="en">

<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1887938272514440" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <title>Daily Workout</title>
    <meta name="description" content="">
    <meta name="author" content="Daily Workout">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="full-screen" content="yes" />
    <meta name="screen-orientation" content="portrait" />


    <link rel="icon" href="/favicon.ico">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <link rel="stylesheet" href="styles.css?v=1.0">
    <script src="scripts.js"></script>
    <!-- <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script> -->
    <script async defer crossorigin="anonymous" src="https://www.facebook.com/assets.php/en_US/fbinstant.latest.js"></script>
</head>

<body>

    <div id="scene-0" class="scene">
        <div class="content" onclick="onCl()">
            <div class="header_text scene_title">Daily Workout</div>
            <div class="centered">
                <div class="progress-spinner"></div>
                <div class="action_demo">
                    <div style="background-image:url('img/1-0.png');"></div>
                </div>
            </div>
            <div class="status header_text">Start</div>
        </div>
    </div>

    <div id="scene-1" class="hidden scene">
        <div id="content" class="content">
            <div id="timer" class="header_text">Timer</div>
            <div id="center_click_handler" class="centered">
                <div id="progress-spinner"></div>
                <div id="action_demo"></div>
            </div>
            <div>
                <div id="status" class="header_text">Ready</div>
                <div id="action_title" class="header_text">Jumps</div>
            </div>
            <div id="progress" class="centered"></div>
        </div>

    </div>

    <div id="scene-2" class="hidden scene">
        <div class="content">
            <div onclick="onCl()" class="header_text scene_title">Start</div>
            <div class="centered" onclick="onCl()">
                <div class="progress-spinner"></div>
                <div class="action_demo">
                    <div style="background-image:url('img/1-0.png');"></div>
                </div>
            </div>
            <div class="header_text scene_title">Day: <span id="score_label"></span> </div>
            <div class="header_text scene_title" onclick="onShareFB()">Well done, <span>share</span>!</div>
        </div>
    </div>

    <script>
        window.onload = function() {
            // When the window loads, start to initialize the SDK
            FBInstant.initializeAsync().then(function() {
                FBInstant.startGameAsync().then(function() {

                    // Select competitor 
                    // FBInstant.context.chooseAsync().then(function() {
                    //     console.log("CONTEXT = " + FBInstant.context.getID());
                    // });

                    rotateAds();
                    onLoadFromStorage();
                    onGetRanks();
                });
            });
        };


        // window.fbAsyncInit = function() {
        //     FB.init({
        //         appId: '2184426505072200',
        //         autoLogAppEvents: true,
        //         xfbml: true,
        //         version: 'v14.0'
        //     });
        // };


        function rotateAds() {
            FBInstant.loadBannerAdAsync('2184426505072200_2185568684957982').then(function() {
                console.log('loadBannerAdAsync resolved.');
            }).catch(function(err) {
                console.error('Banner failed to load: ' + err.message);
            });
        }


        const getBase64FromUrl = async(url) => {
            const data = await fetch(url);
            const blob = await data.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    const base64data = reader.result;
                    resolve(base64data);
                }
            });
        }

        function onShareFB() {
            getBase64FromUrl("assets/218.jpg").then((value) => {
                // let text = `Hey, I've been doing daily workouts for the last ${SCORE} days, join me!`;
                let text = 'Hey, I have been doing daily workouts for the last ' + SCORE + ' days, join me!';
                FBInstant.shareAsync({
                    intent: 'REQUEST',
                    image: value,
                    text: text,
                    // `Hey, I\'m doing Daily Workouts last ${SCORE} days, join me!`,
                    data: {
                        myReplayData: '...'
                    },
                });
            });
        }

        var LAST_ACCESS_TIMESTAMP = new Date().getTime();
        var SCORE = 1;
        var isBestScore = false;

        function saveToStorage() {
            isBestScore = false;
            let now = new Date().getTime();
            let dif = Math.round((now - LAST_ACCESS_TIMESTAMP) / (1000 * 60 * 60 * 24));
            if (dif == 1) {
                SCORE++;
                isBestScore = true;
            } else if (dif > 2) {
                SCORE = 1;
            }

            var data_object = {
                LAST_ACCESS_TIMESTAMP: now,
                SCORE: SCORE,
            };
            FBInstant.player.setDataAsync(data_object)
                .then(function() {
                    // console.log(JSON.stringify(data_object));
                }).catch(function(error) {
                    // Data save failed
                });
        }

        function onLoadFromStorage() {
            FBInstant.player.getDataAsync(["LAST_ACCESS_TIMESTAMP", "SCORE"])
                .then(function(data) {
                    // Data loaded successfully
                    if (data !== undefined && data.LAST_ACCESS_TIMESTAMP !== undefined) {
                        console.log("LA=" + data.LAST_ACCESS_TIMESTAMP);
                        LAST_ACCESS_TIMESTAMP = data.LAST_ACCESS_TIMESTAMP
                    }

                    if (data !== undefined && data.SCORE !== undefined) {
                        console.log("SCORE=" + data.SCORE);
                        SCORE = data.SCORE
                    }

                }).catch(function(error) {
                    // Data load failed
                });
        }

        function onPostToLeaderboard() {
            // https://developers.facebook.com/docs/games/acquire/leaderboards

            // FBInstant
            //     .getLeaderboardAsync('daily_workout_leaderboard.' + FBInstant.context.getID())
            //     .then(leaderboard => {
            //         console.log(leaderboard.getName());
            //         return leaderboard.setScoreAsync(SCORE);
            //     })
            //     .then(() => console.log('Score saved'))
            //     .catch(error => console.error(error));



            // FBInstant.updateAsync({
            //         action: 'LEADERBOARD',
            //         name: 'daily_workout_leaderboard.' + FBInstant.context.getID()
            //     })
            //     .then(() => console.log('Update Posted'))
            //     .catch(error => console.error(error));



            // Post to user Page
            if (isBestScore) {
                FBInstant.postSessionScoreAsync(SCORE)
                    .then(() => {
                        console.log('Update Posted =' + SCORE);
                    });
            }
        }

        function onGetRanks() {

            // FBInstant.getLeaderboardAsync('daily_workout_leaderboard')
            //     .then(leaderboard => {
            //         console.log(leaderboard.getName()); // 'my_awesome_leaderboard'
            //     });


            // FBInstant.getLeaderboardAsync('daily_workout_leaderboard')
            //     .then(leaderboard => leaderboard.getEntriesAsync(10, 0))
            //     .then(entries => {
            //         for (var i = 0; i < entries.length; i++) {
            //             console.log(
            //                 entries[i].getRank() + '. ' +
            //                 entries[i].getPlayer().getName() + ': ' +
            //                 entries[i].getScore()
            //             );
            //         }
            //     }).catch(error => console.error(error));

            // .then(leaderboard => {
            //     console.log(leaderboard.getName()); // 'my_awesome_leaderboard'
            // });



            // FBInstant.getLeaderboardAsync('daily_workout_leaderboard')
            //     .then(leaderboard => leaderboard.getPlayerEntryAsync())
            //     .then(entry => {
            //         console.log(
            //             entries[i].getRank() + '. ' +
            //             entries[i].getPlayer().getName() + ': ' +
            //             entries[i].getScore()
            //         );
            //     }).catch(error => console.error(error));





            // // get total
            // FBInstant
            //     .getLeaderboardAsync('daily_workout_leaderboard.' + FBInstant.context.getID())
            //     .then(leaderboard => leaderboard.getEntriesAsync(10, 0))
            //     .then(entries => {
            //         for (var i = 0; i < entries.length; i++) {
            //             console.log(
            //                 entries[i].getRank() + '. ' +
            //                 entries[i].getPlayer().getName() + ': ' +
            //                 entries[i].getScore()
            //             );
            //         }
            //     }).catch(error => console.error(error));

            // // get user
            // FBInstant
            //     .getLeaderboardAsync('daily_workout_leaderboard.' + FBInstant.context.getID())
            //     .then(leaderboard => leaderboard.getPlayerEntryAsync())
            //     .then(entry => {
            //         console.log(
            //             entries[i].getRank() + '. ' +
            //             entries[i].getPlayer().getName() + ': ' +
            //             entries[i].getScore()
            //         );
            //     }).catch(error => console.error(error));
        }
    </script>
</body>

</html>